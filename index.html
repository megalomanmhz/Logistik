<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì¶ Inventaris QR PRO++</title>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{font-family:system-ui;background:#f1f5f9;padding:16px}
.card{background:#fff;padding:16px;border-radius:12px;margin-bottom:16px}
button,input{padding:6px 10px;margin:2px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #ddd;padding:6px}
.alert{background:#fee2e2;color:#991b1b;padding:10px;border-radius:8px;margin-bottom:10px}
</style>
</head>

<body>

<h2>üì¶ INVENTARIS QR PRO++</h2>
<div id="notif"></div>

<div class="card">
<h3>‚ûï Tambah Barang</h3>
<input id="nama" placeholder="Nama">
<input id="kategori" placeholder="Kategori">
<input id="lokasi" placeholder="Lokasi">
<input id="min" type="number" placeholder="Batas Minimum" value="5">
<button onclick="buatBarang()">Generate QR</button>
<div id="qrcode"></div>
</div>

<div class="card">
<h3>üìã Inventaris</h3>
<table>
<thead>
<tr>
<th>QR</th><th>Nama</th><th>Stok</th><th>Keluar</th><th>Aksi</th>
</tr>
</thead>
<tbody id="tabel"></tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, doc, setDoc,
  updateDoc, increment, onSnapshot,
  addDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCUpAHKrZY7pRKC0zN-j80dhBUW64NSyDE",
  authDomain: "logistik-ef678.firebaseapp.com",
  projectId: "logistik-ef678"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const inv = collection(db,"inventaris");
const log = collection(db,"riwayat");

/* ===== CONFIG WA ===== */
const WA_TOKEN = "ISI_TOKEN_FONNTE_ANDA";
const WA_TUJUAN = "628563057525"; // format internasional

async function kirimWA(pesan){
  await fetch("https://api.fonnte.com/send",{
    method:"POST",
    headers:{
      "Authorization": WA_TOKEN
    },
    body: new URLSearchParams({
      target: WA_TUJUAN,
      message: pesan
    })
  });
}

async function catat(aksi,info){
  await addDoc(log,{aksi,info,waktu:serverTimestamp()});
}

/* ===== TAMBAH BARANG ===== */
window.buatBarang = async ()=>{
  const id="BRG-"+Date.now();
  await setDoc(doc(db,"inventaris",id),{
    id,nama:nama.value,kategori:kategori.value,
    lokasi:lokasi.value,stok:0,min:+min.value
  });
  new QRCode(qrcode,{text:id,width:200,height:200});
  catat("Tambah Barang",nama.value);
};

/* ===== BARANG KELUAR ===== */
window.keluar = async (id,nama,stok)=>{
  const j = parseInt(prompt("Jumlah keluar:"));
  if(!j||j<=0||j>stok) return alert("Jumlah tidak valid");

  await updateDoc(doc(db,"inventaris",id),{
    stok: increment(-j)
  });

  const pesan = `üì¶ BARANG KELUAR
Nama: ${nama}
Jumlah: ${j}
Sisa Stok: ${stok-j}`;

  kirimWA(pesan);
  catat("Barang Keluar",`${nama} (${j})`);
};

/* ===== TABLE + NOTIF ===== */
onSnapshot(inv,(snap)=>{
  tabel.innerHTML="";
  notif.innerHTML="";
  snap.forEach(d=>{
    const b=d.data();
    if(b.stok<=b.min){
      notif.innerHTML+=`<div class="alert">‚ö†Ô∏è Stok ${b.nama} menipis (${b.stok})</div>`;
      kirimWA(`‚ö†Ô∏è STOK MENIPIS\n${b.nama}\nSisa: ${b.stok}`);
    }
    tabel.innerHTML+=`
    <tr>
      <td><img src="https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=${b.id}"></td>
      <td>${b.nama}</td>
      <td>${b.stok}</td>
      <td>
        <button onclick="keluar('${b.id}','${b.nama}',${b.stok})">‚ûñ Keluar</button>
      </td>
      <td>${b.lokasi}</td>
    </tr>`;
  });
});
</script>

</body>
  </html>
